<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>JCC Block Manager</title>

<style>
body { font-family: Arial; margin:10px; }
h2 { text-align:center; }

input, textarea {
  width:100%;
  padding:6px;
  margin-bottom:5px;
  font-size:13px;
}

button {
  padding:6px 10px;
  margin:3px;
  font-size:12px;
  cursor:pointer;
  border:1px solid #ccc;
  background:#f5f5f5;
}

.progress-container {
  height:8px;
  background:#ddd;
  border-radius:4px;
  overflow:hidden;
  margin-bottom:10px;
}

.progress-bar {
  height:8px;
  background:#4caf50;
}

.grid {
  display:grid;
  grid-template-columns: repeat(auto-fit,minmax(180px,1fr));
  gap:10px;
}

.column {
  border:1px solid #ddd;
  border-radius:6px;
  overflow:hidden;
}

.column h4 {
  margin:0;
  padding:6px;
  background:#f3f3f3;
  text-align:center;
  font-size:12px;
}

.block-progress-bg {
  height:6px;
  background:#ddd;
}

.block-progress-fill {
  height:6px;
  background:#4caf50;
}

.cell {
  padding:4px;
  font-size:11px;
  border-bottom:1px solid #eee;
  text-align:center;
  cursor:pointer;
}

.owner { color:black; }
.tenant { color:red; }
.completed { background:#1976d2; color:white !important; }
.selected { background:orange; color:white !important; }

.block-btn.active { background:#1976d2; color:white; }
.block-btn.inactive { background:#e0e0e0; color:#888; }
.filter-btn.active { background:#1976d2; color:white; }

.summary-card {
  min-width:90px;
  padding:6px;
  border:1px solid #ddd;
  border-radius:6px;
  text-align:center;
  font-size:11px;
  background:#fafafa;
}

.summary-percent {
  font-weight:bold;
  font-size:12px;
}

.summary-bar-bg {
  height:5px;
  background:#ddd;
  margin-top:4px;
}

.summary-bar-fill {
  height:5px;
  background:#4caf50;
}

#login { margin-top:80px; text-align:center; }
#app { display:none; }
</style>
</head>
<body>

<!-- LOGIN -->
<div id="login">
  <h2>Secure Login</h2>
  <input type="email" id="email" placeholder="Email"><br>
  <input type="password" id="password" placeholder="Password"><br>
  <button onclick="login()">Login</button>
  <p id="loginError" style="color:red;"></p>
</div>

<!-- APP -->
<div id="app">

<h2>JCC Block Completion Tracker</h2>

<p>Logged in as: <span id="userEmail"></span></p>
<button onclick="logout()">Logout</button>

<div>
Overall: <span id="overallText">0 / 0 (0%)</span>
</div>

<div class="progress-container">
  <div id="overallBar" class="progress-bar" style="width:0%"></div>
</div>

<!-- Top Block Summary -->
<div id="blockSummary" style="display:flex;overflow-x:auto;gap:8px;margin-bottom:10px;"></div>

<input type="text" id="searchBox" placeholder="Search flat number" oninput="applySearch()">

<div id="blockFilters"></div>

<div>
  <button class="filter-btn active" onclick="setFilter('ALL',this)">All</button>
  <button class="filter-btn" onclick="setFilter('OWNER',this)">Owners</button>
  <button class="filter-btn" onclick="setFilter('TENANT',this)">Tenants</button>
  <button class="filter-btn" onclick="setFilter('COMPLETED',this)">Completed</button>
  <button class="filter-btn" onclick="setFilter('PENDING',this)">Pending</button>
  <button onclick="exportCSV()">Export CSV</button>
</div>

<textarea id="inputData" placeholder="Selected flats"></textarea>

<button onclick="markCompleted()">Mark Completed</button>
<button onclick="deleteSelected()">Delete Selected</button>
<button onclick="clearSelection()">Clear Selection</button>

<div class="grid" id="grid"></div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut }
from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore, collection, updateDoc, deleteDoc, doc, onSnapshot }
from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBlmrGDdGBR2VItLa5iNqvy_GyC1Tp-YG4",
  authDomain: "jcc-block-manager.firebaseapp.com",
  projectId: "jcc-block-manager",
  storageBucket: "jcc-block-manager.firebasestorage.app",
  messagingSenderId: "1013753394181",
  appId: "1:1013753394181:web:1c0a826908e3345877186c"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const VALID_BLOCKS = ["A","B","C","D","E","F","G","H","I","J","K"];

let fullData=[];
let selectedFlats=new Set();
let activeFilter="ALL";
let searchTerm="";
let activeBlocks=new Set(VALID_BLOCKS);

const grid=document.getElementById("grid");

/* AUTH */
window.login=async()=>{
  try{
    await signInWithEmailAndPassword(auth,
      document.getElementById("email").value,
      document.getElementById("password").value);
  }catch(err){
    document.getElementById("loginError").innerText=err.message;
  }
}

window.logout=async()=>{ await signOut(auth); }

onAuthStateChanged(auth,user=>{
  if(user){
    document.getElementById("login").style.display="none";
    document.getElementById("app").style.display="block";
    document.getElementById("userEmail").innerText=user.email;
    renderBlockFilters();
  }else{
    document.getElementById("login").style.display="block";
    document.getElementById("app").style.display="none";
  }
});

/* Firestore */
onSnapshot(collection(db,"flats"),snapshot=>{
  fullData=[];
  snapshot.forEach(d=>fullData.push({id:d.id,...d.data()}));
  render();
});

/* Overall */
function updateOverall(){
  const total=fullData.length;
  const completed=fullData.filter(d=>d.completed).length;
  const percent=total?Math.round((completed/total)*100):0;
  document.getElementById("overallText").innerText=
    `${completed} / ${total} (${percent}%)`;
  document.getElementById("overallBar").style.width=percent+"%";
}

/* Block Summary */
function renderBlockSummary(){
  const container=document.getElementById("blockSummary");
  container.innerHTML="";
  VALID_BLOCKS.forEach(letter=>{
    const total=fullData.filter(d=>d.block===letter).length;
    const completed=fullData.filter(d=>d.block===letter && d.completed).length;
    const percent=total?Math.round((completed/total)*100):0;

    const card=document.createElement("div");
    card.className="summary-card";
    card.innerHTML=`
      <div><strong>${letter}</strong></div>
      <div class="summary-percent">${percent}%</div>
      <div>${completed}/${total}</div>
      <div class="summary-bar-bg">
        <div class="summary-bar-fill" style="width:${percent}%"></div>
      </div>
    `;
    container.appendChild(card);
  });
}

/* Filtering */
function applyFilter(data){
  let d=data.filter(x=>activeBlocks.has(x.block));
  if(activeFilter==="OWNER") d=d.filter(x=>x.occupant==="Owner");
  if(activeFilter==="TENANT") d=d.filter(x=>x.occupant==="Tenant");
  if(activeFilter==="COMPLETED") d=d.filter(x=>x.completed);
  if(activeFilter==="PENDING") d=d.filter(x=>!x.completed);
  if(searchTerm) d=d.filter(x=>x.number.toString().includes(searchTerm));
  return d;
}

/* Render */
function render(){
  grid.innerHTML="";
  updateOverall();
  renderBlockSummary();

  const filtered=applyFilter(fullData);

  const blockStats=VALID_BLOCKS.map(letter=>{
    const total=fullData.filter(d=>d.block===letter).length;
    const completed=fullData.filter(d=>d.block===letter && d.completed).length;
    const percent=total?Math.round((completed/total)*100):0;

    return {
      letter,total,completed,percent,
      flats:filtered.filter(d=>d.block===letter)
                    .sort((a,b)=>a.number-b.number)
    };
  })
  .filter(b=>activeBlocks.has(b.letter))
  .sort((a,b)=>b.percent-a.percent);

  blockStats.forEach(block=>{
    const col=document.createElement("div");
    col.className="column";
    col.innerHTML=`
      <h4>${block.letter} (${block.completed}/${block.total}) ${block.percent}%</h4>
      <div class="block-progress-bg">
        <div class="block-progress-fill" style="width:${block.percent}%"></div>
      </div>
    `;

    block.flats.forEach(entry=>{
      const key=entry.block+" "+entry.number;
      const cell=document.createElement("div");
      cell.className="cell "+
        (entry.completed?"completed ":"")+
        (entry.occupant==="Tenant"?"tenant":"owner");
      if(selectedFlats.has(key)) cell.classList.add("selected");
      cell.innerText=key;
      cell.onclick=()=>toggleSelection(key);
      col.appendChild(cell);
    });

    grid.appendChild(col);
  });
}

/* Selection */
function toggleSelection(flat){
  if(selectedFlats.has(flat)) selectedFlats.delete(flat);
  else selectedFlats.add(flat);
  document.getElementById("inputData").value=
    Array.from(selectedFlats).join("\n");
  render();
}

/* Actions */
window.markCompleted=async()=>{
  for(const entry of fullData){
    const key=entry.block+" "+entry.number;
    if(selectedFlats.has(key)){
      await updateDoc(doc(db,"flats",entry.id),{completed:true});
    }
  }
  clearSelection();
}

window.deleteSelected=async()=>{
  if(!confirm("Delete selected flats?")) return;
  for(const entry of fullData){
    const key=entry.block+" "+entry.number;
    if(selectedFlats.has(key)){
      await deleteDoc(doc(db,"flats",entry.id));
    }
  }
  clearSelection();
}

window.clearSelection=()=>{
  selectedFlats.clear();
  document.getElementById("inputData").value="";
  render();
}

window.setFilter=(f,btn)=>{
  activeFilter=f;
  document.querySelectorAll(".filter-btn")
    .forEach(b=>b.classList.remove("active"));
  btn.classList.add("active");
  render();
}

window.applySearch=()=>{
  searchTerm=document.getElementById("searchBox").value.trim();
  render();
}

window.exportCSV=()=>{
  const data=applyFilter(fullData);
  let csv="Block,Number,Occupant,Completed\n";
  data.forEach(d=>{
    csv+=`${d.block},${d.number},${d.occupant},${d.completed}\n`;
  });
  const blob=new Blob([csv],{type:"text/csv"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url;
  a.download="block_tracker_export.csv";
  a.click();
}

/* Block Filters */
function renderBlockFilters(){
  const container=document.getElementById("blockFilters");
  container.innerHTML="";
  VALID_BLOCKS.forEach(letter=>{
    const btn=document.createElement("button");
    btn.innerText=letter;
    btn.className="block-btn";
    if(activeBlocks.has(letter))
      btn.classList.add("active");
    else
      btn.classList.add("inactive");
    btn.onclick=()=>{
      if(activeBlocks.has(letter))
        activeBlocks.delete(letter);
      else
        activeBlocks.add(letter);
      renderBlockFilters();
      render();
    };
    container.appendChild(btn);
  });
}
</script>

</body>
</html>
