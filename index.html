<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>JCC Block Manager</title>
</head>
<body>

<div id="login">
  <h2>Login</h2>
  <input type="email" id="email" placeholder="Email"><br>
  <input type="password" id="password" placeholder="Password"><br>
  <button id="loginBtn">Login</button>
  <p id="loginError" style="color:red;"></p>
</div>

<div id="app" style="display:none;">
  <h2>Block Tracker</h2>
  <p>Logged in as: <span id="userEmail"></span></p>
  <button id="logoutBtn">Logout</button>

  <textarea id="inputData" placeholder="Selected flats"></textarea><br>

  <button id="markBtn">Mark Completed</button>
  <button id="unmarkBtn">Unmark Completed</button>
  <button id="clearBtn">Clear Selection</button>

  <div id="grid"></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut }
from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore, collection, updateDoc, doc, onSnapshot }
from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBlmrGDdGBR2VItLa5iNqvy_GyC1Tp-YG4",
  authDomain: "jcc-block-manager.firebaseapp.com",
  projectId: "jcc-block-manager",
  storageBucket: "jcc-block-manager.firebasestorage.app",
  messagingSenderId: "1013753394181",
  appId: "1:1013753394181:web:1c0a826908e3345877186c"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const loginDiv = document.getElementById("login");
const appDiv = document.getElementById("app");
const emailInput = document.getElementById("email");
const passwordInput = document.getElementById("password");
const loginBtn = document.getElementById("loginBtn");
const logoutBtn = document.getElementById("logoutBtn");
const loginError = document.getElementById("loginError");
const userEmail = document.getElementById("userEmail");
const markBtn = document.getElementById("markBtn");
const unmarkBtn = document.getElementById("unmarkBtn");
const clearBtn = document.getElementById("clearBtn");
const inputData = document.getElementById("inputData");

let fullData = [];
let selectedFlats = new Set();

/* AUTH */

loginBtn.addEventListener("click", async () => {
  try {
    await signInWithEmailAndPassword(
      auth,
      emailInput.value,
      passwordInput.value
    );
  } catch (err) {
    loginError.innerText = err.message;
  }
});

logoutBtn.addEventListener("click", () => signOut(auth));

onAuthStateChanged(auth, user => {
  if (user) {
    loginDiv.style.display = "none";
    appDiv.style.display = "block";
    userEmail.innerText = user.email;
  } else {
    loginDiv.style.display = "block";
    appDiv.style.display = "none";
  }
});

/* REALTIME DATA */

onSnapshot(collection(db, "flats"), snapshot => {
  fullData = [];
  snapshot.forEach(docSnap => {
    fullData.push({ id: docSnap.id, ...docSnap.data() });
  });
});

/* ACTIONS */

markBtn.addEventListener("click", async () => {
  for (const entry of fullData) {
    const key = entry.block + " " + entry.number;
    if (selectedFlats.has(key)) {
      await updateDoc(doc(db, "flats", entry.id), {
        completed: true
      });
    }
  }
  selectedFlats.clear();
  inputData.value = "";
});

unmarkBtn.addEventListener("click", async () => {
  for (const entry of fullData) {
    const key = entry.block + " " + entry.number;
    if (selectedFlats.has(key)) {
      await updateDoc(doc(db, "flats", entry.id), {
        completed: false
      });
    }
  }
  selectedFlats.clear();
  inputData.value = "";
});

clearBtn.addEventListener("click", () => {
  selectedFlats.clear();
  inputData.value = "";
});
</script>

</body>
</html>
