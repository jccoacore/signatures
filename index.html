<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>JCC Block Tracker</title>

<style>
body { font-family: Arial; margin: 10px; }

h2 { text-align: center; font-size: 18px; }

.stats {
  text-align: center;
  margin-bottom: 5px;
  font-size: 13px;
  font-weight: bold;
}

.progress-container {
  height: 8px;
  background: #ddd;
  border-radius: 4px;
  overflow: hidden;
  margin-bottom: 10px;
}

.progress-bar {
  height: 8px;
  background: #4caf50;
}

textarea, input[type="text"] {
  width: 100%;
  padding: 6px;
  font-size: 13px;
  margin-bottom: 5px;
}

button {
  padding: 5px 8px;
  font-size: 12px;
  margin: 3px;
  cursor: pointer;
}

.filters { text-align: center; margin-bottom: 6px; }

.filter-btn {
  background: #f0f0f0;
  border: 1px solid #ccc;
  border-radius: 4px;
}

.filter-btn.active {
  background: #1976d2;
  color: white;
}

.grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
  gap: 6px;
  margin-top: 8px;
}

.column {
  border: 1px solid #ddd;
  border-radius: 5px;
  overflow: hidden;
}

.column h4 {
  text-align: center;
  background: #f3f3f3;
  margin: 0;
  padding: 4px;
  font-size: 12px;
}

.cell {
  padding: 4px;
  font-size: 11px;
  border-bottom: 1px solid #eee;
  text-align: center;
  cursor: pointer;
}

.owner { color: black; }
.tenant { color: red; }

.completed {
  background: #1976d2;
  color: white !important;
}
</style>
</head>
<body>

<h2>JCC Block Completion Tracker</h2>

<div class="stats">
Overall: <span id="overallText">0 / 0 (0%)</span>
</div>

<div class="progress-container">
  <div id="overallBar" class="progress-bar" style="width:0%"></div>
</div>

<input type="text" id="searchBox" placeholder="Search flat number (e.g. 810)" oninput="applySearch()">

<div class="filters">
  <button class="filter-btn active" onclick="setFilter('ALL', this)">All</button>
  <button class="filter-btn" onclick="setFilter('OWNER', this)">Owners</button>
  <button class="filter-btn" onclick="setFilter('TENANT', this)">Tenants</button>
  <button class="filter-btn" onclick="setFilter('COMPLETED', this)">Completed</button>
  <button class="filter-btn" onclick="setFilter('PENDING', this)">Pending</button>
  <button onclick="exportCSV()">Export CSV</button>
</div>

<textarea id="inputData" placeholder="A 101"></textarea>
<br>
<button onclick="markCompleted()">Mark Completed</button>

<div class="grid" id="grid"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, collection, updateDoc, doc, onSnapshot } 
from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBlmrGDdGBR2VItLa5iNqvy_GyC1Tp-YG4",
  authDomain: "jcc-block-manager.firebaseapp.com",
  projectId: "jcc-block-manager",
  storageBucket: "jcc-block-manager.firebasestorage.app",
  messagingSenderId: "1013753394181",
  appId: "1:1013753394181:web:1c0a826908e3345877186c"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const VALID_BLOCKS = ["A","B","C","D","E","F","G","H","I","J","K"];

let fullData = [];
let activeFilter = "ALL";
let searchTerm = "";

const grid = document.getElementById("grid");

function applyFilter(data){
  let filtered = data;

  if(activeFilter === "OWNER")
    filtered = filtered.filter(d => d.occupant === "Owner");
  if(activeFilter === "TENANT")
    filtered = filtered.filter(d => d.occupant === "Tenant");
  if(activeFilter === "COMPLETED")
    filtered = filtered.filter(d => d.completed);
  if(activeFilter === "PENDING")
    filtered = filtered.filter(d => !d.completed);

  if(searchTerm){
    filtered = filtered.filter(d => 
      d.number.toString().includes(searchTerm)
    );
  }

  return filtered;
}

function updateOverallProgress(){
  const total = fullData.length;
  const completed = fullData.filter(d=>d.completed).length;
  const percent = total === 0 ? 0 : Math.round((completed/total)*100);

  document.getElementById("overallText").innerText =
    `${completed} / ${total} (${percent}%)`;

  document.getElementById("overallBar").style.width = percent + "%";
}

function render(data){
  grid.innerHTML = "";
  updateOverallProgress();

  const blocks = {};
  VALID_BLOCKS.forEach(letter => blocks[letter] = []);

  data.forEach(item=>{
    if(VALID_BLOCKS.includes(item.block)){
      blocks[item.block].push(item);
    }
  });

  VALID_BLOCKS.forEach(letter=>{
    blocks[letter].sort((a,b)=>a.number-b.number);

    const col=document.createElement("div");
    col.className="column";
    col.innerHTML=`<h4>${letter}</h4>`;

    blocks[letter].forEach(entry=>{
      const cell=document.createElement("div");
      let occupantClass = entry.occupant === "Tenant" ? "tenant" : "owner";
      cell.className = "cell " + occupantClass;
      if(entry.completed) cell.classList.add("completed");

      cell.innerText = letter+" "+entry.number;

      cell.onclick = async () => {
        await updateDoc(doc(db,"flats",entry.id),{
          completed: !entry.completed
        });
      };

      col.appendChild(cell);
    });

    grid.appendChild(col);
  });
}

window.setFilter = function(filter, btn){
  activeFilter = filter;
  document.querySelectorAll(".filter-btn")
    .forEach(b=>b.classList.remove("active"));
  btn.classList.add("active");
  render(applyFilter(fullData));
}

window.applySearch = function(){
  searchTerm = document.getElementById("searchBox").value.trim();
  render(applyFilter(fullData));
}

window.markCompleted = async function(){
  const input=document.getElementById("inputData").value.trim();
  if(!input) return;

  const lines=input.split("\n");

  fullData.forEach(async entry=>{
    lines.forEach(async line=>{
      const parts=line.trim().split(/\s+/);
      if(parts.length<2) return;

      const block=parts[0].toUpperCase();
      const number=parseInt(parts[1]);

      if(entry.block===block && entry.number===number){
        await updateDoc(doc(db,"flats",entry.id),{
          completed:true
        });
      }
    });
  });

  document.getElementById("inputData").value="";
}

window.exportCSV = function(){
  const dataToExport = applyFilter(fullData);

  let csv = "Block,Number,Occupant,Completed\n";

  dataToExport.forEach(d=>{
    csv += `${d.block},${d.number},${d.occupant},${d.completed}\n`;
  });

  const blob = new Blob([csv], { type: "text/csv" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "block_tracker_export.csv";
  a.click();
}

onSnapshot(collection(db,"flats"),snapshot=>{
  fullData=[];
  snapshot.forEach(doc=>{
    fullData.push({id:doc.id,...doc.data()});
  });
  render(applyFilter(fullData));
});
</script>

</body>
</html>
