<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Block Tracker</title>

<style>
body { font-family: Arial; margin:10px; }
h2 { margin-bottom:5px; }

.stat-box {
  display:flex; gap:10px; flex-wrap:wrap;
  font-size:12px; margin-bottom:6px;
}
.stat-item {
  background:#f3f3f3;
  padding:4px 8px;
  border-radius:5px;
}

.progress-container {
  height:6px;
  background:#ddd;
  border-radius:4px;
  overflow:hidden;
  margin-bottom:8px;
}
.progress-bar {
  height:6px;
  background:#4caf50;
}

.summary-card {
  min-width:80px;
  padding:5px;
  border:1px solid #ddd;
  border-radius:5px;
  font-size:10px;
  text-align:center;
  cursor:pointer;
}
.summary-card.active {
  border:2px solid #1976d2;
  background:#e3f2fd;
}
.summary-card.inactive {
  opacity:0.35;
}
.summary-bar-bg {
  height:4px;
  background:#ddd;
  margin-top:3px;
}
.summary-bar-fill {
  height:4px;
  background:#4caf50;
}

.grid {
  display:grid;
  grid-template-columns: repeat(auto-fit,minmax(170px,1fr));
  gap:10px;
}
.column {
  border:1px solid #ddd;
  border-radius:5px;
}
.column h4 {
  margin:0;
  padding:4px;
  font-size:11px;
  background:#f3f3f3;
  text-align:center;
}
.block-progress-bg {
  height:4px;
  background:#ddd;
}
.block-progress-fill {
  height:4px;
  background:#4caf50;
}
.cell {
  padding:3px;
  font-size:10px;
  text-align:center;
  border-bottom:1px solid #eee;
  cursor:pointer;
  display:flex;
  justify-content:center;
  gap:6px;
}

.owner { color:black; }
.tenant { color:red; }

.badge { font-weight:bold; }
.owner-badge { color:green; }
.tenant-badge { color:orange; }

.completed { background:#1976d2; color:white !important; }
.selected { background:orange; color:white !important; }

textarea, input {
  width:100%;
  padding:4px;
  margin-bottom:5px;
  font-size:12px;
}

button {
  padding:4px 8px;
  margin:3px;
  font-size:11px;
  cursor:pointer;
}
.filter-btn.active {
  background:#1976d2;
  color:white;
}

#app { display:none; }
</style>
</head>
<body>

<div id="login">
  <h2>Login</h2>
  <input type="email" id="emailInput" placeholder="Email"><br>
  <input type="password" id="passwordInput" placeholder="Password"><br>
  <button id="loginBtn">Login</button>
  <p id="loginError" style="color:red;"></p>
</div>

<div id="app">
  <h2>Block Tracker</h2>
  <p>Logged in as: <span id="userEmail"></span></p>
  <button id="logoutBtn">Logout</button>

  <div class="stat-box">
    <div class="stat-item">Total: <span id="socTotal">0</span></div>
    <div class="stat-item">Completed: <span id="socCompleted">0</span></div>
    <div class="stat-item">Owners: <span id="socOwners">0</span></div>
    <div class="stat-item">Tenants: <span id="socTenants">0</span></div>
    <div class="stat-item">Overall %: <span id="socPercent">0%</span></div>
  </div>

  <div class="progress-container">
    <div id="overallBar" class="progress-bar"></div>
  </div>

  <div id="blockSummary" style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:8px;"></div>

  <input type="text" id="searchBox" placeholder="Search flat number">

  <div>
    <button class="filter-btn active" data-filter="ALL">All</button>
    <button class="filter-btn" data-filter="OWNER">Owners</button>
    <button class="filter-btn" data-filter="TENANT">Tenants</button>
    <button class="filter-btn" data-filter="COMPLETED">Completed</button>
    <button class="filter-btn" data-filter="PENDING">Pending</button>

    <!-- NEW Advanced Filters -->
    <button class="filter-btn" data-filter="OWNER_COMPLETED">Owner+Completed</button>
    <button class="filter-btn" data-filter="OWNER_PENDING">Owner+Pending</button>
    <button class="filter-btn" data-filter="TENANT_COMPLETED">Tenant+Completed</button>
    <button class="filter-btn" data-filter="TENANT_PENDING">Tenant+Pending</button>
  </div>

  <textarea id="inputData" placeholder="Selected flats"></textarea>

  <button id="markBtn">Mark Completed</button>
  <button id="unmarkBtn">Unmark Completed</button>
  <button id="clearBtn">Clear Selection</button>
  <button onclick="downloadSnapshot()">Download CSV Snapshot</button>
  <button onclick="manualReload()">Refresh</button>

  <div class="grid" id="grid"></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut }
from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore, collection, updateDoc, doc, onSnapshot, getDocs }
from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBlmrGDdGBR2VItLa5iNqvy_GyC1Tp-YG4",
  authDomain: "jcc-block-manager.firebaseapp.com",
  projectId: "jcc-block-manager"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const VALID_BLOCKS = ["A","B","C","D","E","F","G","H","I","J","K"];

let fullData = [];
let selectedFlats = new Set();
let activeBlocks = new Set(VALID_BLOCKS);
let activeFilter = "ALL";
let searchTerm = "";

const loginDiv = document.getElementById("login");
const appDiv = document.getElementById("app");
const loginBtn = document.getElementById("loginBtn");
const logoutBtn = document.getElementById("logoutBtn");
const loginError = document.getElementById("loginError");
const userEmail = document.getElementById("userEmail");
const emailInput = document.getElementById("emailInput");
const passwordInput = document.getElementById("passwordInput");
const grid = document.getElementById("grid");
const inputData = document.getElementById("inputData");

/* AUTH */
/* AUTH */
loginBtn.addEventListener("click", async () => {
  try {
    await signInWithEmailAndPassword(
      auth,
      emailInput.value.trim(),
      passwordInput.value.trim()
    );
  } catch (err) {
    loginError.innerText = err.message;
    console.error("Login error:", err);
  }
});

logoutBtn.addEventListener("click", () => signOut(auth));

onAuthStateChanged(auth, user => {
  if (user) {
    loginDiv.style.display = "none";
    appDiv.style.display = "block";
    userEmail.innerText = user.email;
  } else {
    loginDiv.style.display = "block";
    appDiv.style.display = "none";
  }
});


/* REALTIME */
onSnapshot(collection(db,"flats"),snap=>{
  fullData=[];
  snap.forEach(d=>{
    const data=d.data();
    if(VALID_BLOCKS.includes(data.block)){
      fullData.push({id:d.id,...data});
    }
  });
  render();
});

/* SEARCH */
document.getElementById("searchBox")
.addEventListener("input",e=>{
  searchTerm=e.target.value.trim();
  render();
});

/* FILTER BUTTONS */
document.querySelectorAll(".filter-btn").forEach(btn=>{
  btn.addEventListener("click",()=>{
    document.querySelectorAll(".filter-btn")
      .forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");
    activeFilter=btn.dataset.filter;
    render();
  });
});

/* APPLY FILTER */
function applyFilter(data){
  let d=data.filter(x=>activeBlocks.has(x.block));

  switch(activeFilter){
    case "OWNER": d=d.filter(x=>x.occupant==="Owner"); break;
    case "TENANT": d=d.filter(x=>x.occupant==="Tenant"); break;
    case "COMPLETED": d=d.filter(x=>x.completed); break;
    case "PENDING": d=d.filter(x=>!x.completed); break;
    case "OWNER_COMPLETED": d=d.filter(x=>x.occupant==="Owner" && x.completed); break;
    case "OWNER_PENDING": d=d.filter(x=>x.occupant==="Owner" && !x.completed); break;
    case "TENANT_COMPLETED": d=d.filter(x=>x.occupant==="Tenant" && x.completed); break;
    case "TENANT_PENDING": d=d.filter(x=>x.occupant==="Tenant" && !x.completed); break;
  }

  if(searchTerm) d=d.filter(x=>x.number.toString().includes(searchTerm));
  return d;
}
  function render(){
  renderStats();
  renderDashboard();

  grid.innerHTML="";
  const filtered=applyFilter(fullData);

  VALID_BLOCKS.forEach(letter=>{
    if(!activeBlocks.has(letter)) return;

    const flats=filtered.filter(f=>f.block===letter);

    const total=fullData.filter(f=>f.block===letter).length;
    const completed=fullData.filter(f=>f.block===letter && f.completed).length;
    const percent=total?Math.round((completed/total)*100):0;

    const col=document.createElement("div");
    col.className="column";
    col.innerHTML=`
      <h4>${letter} (${completed}/${total}) ${percent}%</h4>
      <div class="block-progress-bg">
        <div class="block-progress-fill" style="width:${percent}%"></div>
      </div>
    `;

    flats.sort((a,b)=>a.number-b.number).forEach(entry=>{
      const key=entry.block+" "+entry.number;

      const badge = entry.occupant==="Owner" ? "O" : "T";

      const cell=document.createElement("div");
      cell.className="cell "+
        (entry.completed?"completed ":"")+
        (entry.occupant==="Tenant"?"tenant":"owner");

      if(selectedFlats.has(key)) cell.classList.add("selected");

      cell.innerHTML=`
        <span>${key}</span>
        <span class="badge ${badge==="O"?"owner-badge":"tenant-badge"}">
          ${badge}
        </span>
      `;

      cell.onclick=()=>toggleSelection(key);
      col.appendChild(cell);
    });

    grid.appendChild(col);
  });
}

/* DASHBOARD FILTER + BLOCK SUMMARY */
function renderDashboard(){
  const container=document.getElementById("blockSummary");
  container.innerHTML="";

  VALID_BLOCKS.forEach(letter=>{
    const total=fullData.filter(f=>f.block===letter).length;
    const completed=fullData.filter(f=>f.block===letter && f.completed).length;
    const owners=fullData.filter(f=>f.block===letter && f.occupant==="Owner").length;
    const tenants=fullData.filter(f=>f.block===letter && f.occupant==="Tenant").length;

    const percent=total?Math.round((completed/total)*100):0;

    const card=document.createElement("div");
    card.className="summary-card";

    if(activeBlocks.has(letter)) card.classList.add("active");
    else card.classList.add("inactive");

    card.innerHTML=`
      <div><b>${letter}</b></div>
      <div>${percent}%</div>
      <div>${completed}/${total}</div>
      <div>O:${owners} T:${tenants}</div>
      <div class="summary-bar-bg">
        <div class="summary-bar-fill" style="width:${percent}%"></div>
      </div>
    `;

    card.onclick=()=>{
      if(activeBlocks.has(letter)) activeBlocks.delete(letter);
      else activeBlocks.add(letter);
      render();
    };

    container.appendChild(card);
  });
}

/* STATS */
function renderStats(){
  const total=fullData.length;
  const completed=fullData.filter(f=>f.completed).length;
  const owners=fullData.filter(f=>f.occupant==="Owner").length;
  const tenants=fullData.filter(f=>f.occupant==="Tenant").length;
  const percent=total?Math.round((completed/total)*100):0;

  document.getElementById("socTotal").innerText=total;
  document.getElementById("socCompleted").innerText=completed;
  document.getElementById("socOwners").innerText=owners;
  document.getElementById("socTenants").innerText=tenants;
  document.getElementById("socPercent").innerText=percent+"%";
  document.getElementById("overallBar").style.width=percent+"%";
}

/* SELECTION */
function toggleSelection(flat){
  if(selectedFlats.has(flat)) selectedFlats.delete(flat);
  else selectedFlats.add(flat);

  inputData.value=Array.from(selectedFlats).join("\n");
  render();
}

/* MANUAL REFRESH */
window.manualReload = async function(){
  const snap = await getDocs(collection(db,"flats"));
  fullData=[];
  snap.forEach(d=>{
    const data=d.data();
    if(VALID_BLOCKS.includes(data.block)){
      fullData.push({id:d.id,...data});
    }
  });
  render();
};

/* ACTIONS */
document.getElementById("markBtn").onclick=async()=>{
  for(const e of fullData){
    const key=e.block+" "+e.number;
    if(selectedFlats.has(key)){
      await updateDoc(doc(db,"flats",e.id),{completed:true});
    }
  }
  selectedFlats.clear();
  inputData.value="";
};

document.getElementById("unmarkBtn").onclick=async()=>{
  for(const e of fullData){
    const key=e.block+" "+e.number;
    if(selectedFlats.has(key)){
      await updateDoc(doc(db,"flats",e.id),{completed:false});
    }
  }
  selectedFlats.clear();
  inputData.value="";
};

document.getElementById("clearBtn").onclick=()=>{
  selectedFlats.clear();
  inputData.value="";
  render();
};

/* CSV SNAPSHOT */
window.downloadSnapshot=function(){
  let csv="Block,Flat Number,Occupant Type,Completed\n";
  fullData.forEach(f=>{
    csv+=`${f.block},${f.number},${f.occupant},${f.completed}\n`;
  });

  const blob=new Blob([csv],{type:"text/csv;charset=utf-8;"});
  const link=document.createElement("a");
  link.href=URL.createObjectURL(blob);
  link.download="flats_snapshot.csv";
  link.click();
};

