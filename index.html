<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>JCC Block Tracker</title>
<style>
body { font-family: Arial; margin: 15px; }
button { padding: 6px 10px; margin: 5px; cursor:pointer; }
input { padding:6px; margin:5px; }
#app { display:none; }
.grid {
  display:grid;
  grid-template-columns: repeat(auto-fit,minmax(150px,1fr));
  gap:6px;
  margin-top:10px;
}
.column { border:1px solid #ddd; border-radius:5px; overflow:hidden; }
.column h4 { margin:0; padding:5px; background:#f3f3f3; text-align:center; }
.cell { padding:4px; font-size:11px; border-bottom:1px solid #eee; text-align:center; }
.completed { background:#1976d2; color:white; }
.owner { color:black; }
.tenant { color:red; }
</style>
</head>
<body>

<!-- LOGIN -->
<div id="login">
  <h2>JCC Secure Login</h2>
  <input type="email" id="email" placeholder="Email"><br>
  <input type="password" id="password" placeholder="Password"><br>
  <button onclick="login()">Login</button>
  <p id="loginError" style="color:red;"></p>
</div>

<!-- APP -->
<div id="app">
  <h2>JCC Block Tracker</h2>
  <p>Logged in as: <span id="userEmail"></span></p>
  <button onclick="logout()">Logout</button>
  <div class="grid" id="grid"></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { 
  getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut 
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { 
  getFirestore, collection, updateDoc, doc, onSnapshot 
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBlmrGDdGBR2VItLa5iNqvy_GyC1Tp-YG4",
  authDomain: "jcc-block-manager.firebaseapp.com",
  projectId: "jcc-block-manager",
  storageBucket: "jcc-block-manager.firebasestorage.app",
  messagingSenderId: "1013753394181",
  appId: "1:1013753394181:web:1c0a826908e3345877186c"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const VALID_BLOCKS = ["A","B","C","D","E","F","G","H","I","J","K"];
let fullData = [];
const grid = document.getElementById("grid");

/* AUTH */
window.login = async function(){
  const email = document.getElementById("email").value;
  const password = document.getElementById("password").value;

  try {
    await signInWithEmailAndPassword(auth,email,password);
  } catch(err){
    document.getElementById("loginError").innerText = err.message;
  }
}

window.logout = async function(){
  await signOut(auth);
}

onAuthStateChanged(auth,user=>{
  if(user){
    document.getElementById("login").style.display="none";
    document.getElementById("app").style.display="block";
    document.getElementById("userEmail").innerText = user.email;
  } else {
    document.getElementById("login").style.display="block";
    document.getElementById("app").style.display="none";
  }
});

/* FIRESTORE LISTENER */
onSnapshot(collection(db,"flats"),snapshot=>{
  fullData=[];
  snapshot.forEach(doc=>{
    fullData.push({id:doc.id,...doc.data()});
  });
  render();
});

function render(){
  grid.innerHTML="";
  const blocks = {};
  VALID_BLOCKS.forEach(l=>blocks[l]=[]);

  fullData.forEach(d=>blocks[d.block].push(d));

  VALID_BLOCKS.forEach(letter=>{
    blocks[letter].sort((a,b)=>a.number-b.number);
    const col=document.createElement("div");
    col.className="column";
    col.innerHTML=`<h4>${letter}</h4>`;

    blocks[letter].forEach(entry=>{
      const cell=document.createElement("div");
      cell.className="cell " + 
        (entry.completed ? "completed " : "") +
        (entry.occupant==="Tenant"?"tenant":"owner");

      cell.innerText=letter+" "+entry.number;

      cell.onclick=async ()=>{
        await updateDoc(doc(db,"flats",entry.id),{
          completed:!entry.completed
        });
      };

      col.appendChild(cell);
    });

    grid.appendChild(col);
  });
}
</script>

</body>
</html>
