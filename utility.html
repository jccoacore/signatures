<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Secure Admin Utility</title>
</head>
<body>

<div id="loginSection">
  <h2>Admin Login</h2>
  <input type="email" id="emailInput" placeholder="Email"><br>
  <input type="password" id="passwordInput" placeholder="Password"><br>
  <button id="loginBtn">Login</button>
  <p id="loginError" style="color:red;"></p>
</div>

<div id="adminSection" style="display:none;">
  <h2>Admin Utility</h2>
  <p>Logged in as: <span id="adminEmail"></span></p>
  <button id="logoutBtn">Logout</button>

  <hr>

  <h3>Add Flat</h3>
  <input id="blockInput" placeholder="Block (A-K)">
  <input id="numberInput" type="number" placeholder="Flat Number">
  <input id="occupantInput" placeholder="Owner/Tenant">
  <br><br>
  <button id="addBtn">Add Flat</button>

  <hr>

  <h3>Delete Flat</h3>
  <input id="delBlockInput" placeholder="Block">
  <input id="delNumberInput" type="number" placeholder="Flat Number">
  <br><br>
  <button id="deleteBtn">Delete Flat</button>

  <p id="status"></p>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut }
from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore, collection, addDoc, query, where, getDocs, deleteDoc }
from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBlmrGDdGBR2VItLa5iNqvy_GyC1Tp-YG4",
  authDomain: "jcc-block-manager.firebaseapp.com",
  projectId: "jcc-block-manager",
  storageBucket: "jcc-block-manager.firebasestorage.app",
  messagingSenderId: "1013753394181",
  appId: "1:1013753394181:web:1c0a826908e3345877186c"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const loginSection = document.getElementById("loginSection");
const adminSection = document.getElementById("adminSection");
const emailInput = document.getElementById("emailInput");
const passwordInput = document.getElementById("passwordInput");
const loginBtn = document.getElementById("loginBtn");
const logoutBtn = document.getElementById("logoutBtn");
const loginError = document.getElementById("loginError");
const adminEmail = document.getElementById("adminEmail");
const status = document.getElementById("status");

/* AUTH HANDLING */
loginBtn.addEventListener("click", async () => {
  try {
    await signInWithEmailAndPassword(
      auth,
      emailInput.value,
      passwordInput.value
    );
  } catch (err) {
    loginError.innerText = err.message;
    console.error("Login error:", err);
  }
});

logoutBtn.addEventListener("click", () => signOut(auth));

onAuthStateChanged(auth, user => {
  if (user) {
    loginSection.style.display = "none";
    adminSection.style.display = "block";
    adminEmail.innerText = user.email;
  } else {
    loginSection.style.display = "block";
    adminSection.style.display = "none";
  }
});

/* ADD FLAT */
document.getElementById("addBtn").addEventListener("click", async () => {
  if (!auth.currentUser) {
    status.innerText = "Not authenticated!";
    return;
  }

  try {
    const docRef = await addDoc(collection(db, "flats"), {
      block: document.getElementById("blockInput").value.toUpperCase(),
      number: Number(document.getElementById("numberInput").value),
      occupant: document.getElementById("occupantInput").value,
      completed: false
    });

    status.innerText = "Flat Added. ID: " + docRef.id;
    console.log("Flat added:", docRef.id);
  } catch (err) {
    status.innerText = "Error: " + err.message;
    console.error("Add error:", err);
  }
});

/* DELETE FLAT */
document.getElementById("deleteBtn").addEventListener("click", async () => {
  if (!auth.currentUser) {
    status.innerText = "Not authenticated!";
    return;
  }

  try {
    const q = query(
      collection(db, "flats"),
      where("block", "==",
        document.getElementById("delBlockInput").value.toUpperCase()),
      where("number", "==",
        Number(document.getElementById("delNumberInput").value))
    );

    const snapshot = await getDocs(q);

    if (snapshot.empty) {
      status.innerText = "No matching flat found.";
      return;
    }

    for (const docSnap of snapshot.docs) {
      await deleteDoc(docSnap.ref);
    }

    status.innerText = "Flat deleted successfully.";
  } catch (err) {
    status.innerText = "Error: " + err.message;
    console.error("Delete error:", err);
  }
});
</script>

</body>
</html>
